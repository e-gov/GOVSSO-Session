load_module modules/ngx_http_headers_more_filter_module.so;

user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log notice;
pid /var/run/nginx.pid;
events {
    worker_connections  1024;
}

http {
  access_log /var/log/nginx/access.log;

  # Hide server version from Server header
  server_tokens off;

  # Remove response headers set by server.
  more_clear_headers X-Powered-By;
  more_clear_headers X-Varnish;
  more_clear_headers Via;
  more_clear_headers Server;

  # Prevents rewriting of Location header incase of proxy_redirect
  proxy_redirect off;

  # Sets X-Forwarded-For header with client IP address, overwrites if set by client.
  proxy_set_header X-Forwarded-For $remote_addr;

  server {
    listen              13443 ssl http2;
    server_name         gateway;
    ssl_certificate     /var/certs/gateway.localhost.crt;
    ssl_certificate_key /var/certs/gateway.localhost.key;
    ssl_protocols       TLSv1 TLSv1.1 TLSv1.2 TLSv1.3;
    proxy_ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3;

    location = /.well-known/openid-configuration {
      proxy_pass https://hydra:8443;
    }
    location = /.well-known/jwks.json {
      proxy_pass https://hydra:8443;
    }

    location = /oauth2/auth {
      # TODO: Possibly check against registered clients in the future.
      # if ($http_origin ~ '^https?://(localhost|www\.yourdomain\.com|www\.yourotherdomain\.com)') {
      #   set $cors 'true';
      # }

      # Set CORS headers for session extension process.
      if ($arg_prompt = 'none') {
        add_header 'Access-Control-Allow-Origin' "$http_origin" always;
        add_header 'Access-Control-Allow-Credentials' 'true' always;
      }

      # Add 'prompt=consent' query parameter, if missing.
      if ($arg_prompt = '') {
        # Break, so rewritten request is not passed to another location.
        rewrite ^ /oauth2/auth?prompt=consent break;
      }
      # Adds 'traceparent' header ONLY if URL contains query parameter 'traceparent' with value.
      add_header traceparent $arg_traceparent;

      proxy_pass https://hydra:8443;
    }

    location = /oauth2/sessions/logout {
      # Adds 'traceparent' header ONLY if URL contains query parameter 'traceparent' with value.
      add_header traceparent $arg_traceparent;
      proxy_pass https://hydra:8443;
    }

    location = /oauth2/token {
      proxy_pass https://hydra:8443;
    }

    # Hides actuator endpoints from public use.
    # The tilde and asterisks ensure that this location will be matched case insensitively.
    location ~* ^/actuator {
      return https://session:15443/notfound;
    }

    # Exact match with no extra path - '{port}://{hostname}/'
    # Needed because redirect to www.ria.ee should trigger only when location has no addition path and parameters.
    location = / {
      if ($request_method = GET) {
        return 302 https://www.ria.ee/et/riigi-infosusteem/eid/partnerile.html;
      }
      proxy_pass https://session:15443;
    }

    # All other locations
    location / {
      proxy_pass https://session:15443;
    }
  }
}
